<!DOCTYPE html>
<html>
<head>
    <title>S3 CORS Test</title>
    <style>
        body {
            font-family: monospace;
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }
        .test {
            margin: 20px 0;
            padding: 15px;
            border: 2px solid #ccc;
            border-radius: 5px;
        }
        .success {
            border-color: #4CAF50;
            background-color: #f1f8f4;
        }
        .error {
            border-color: #f44336;
            background-color: #fef1f0;
        }
        .pending {
            border-color: #2196F3;
            background-color: #f0f7ff;
        }
        pre {
            background: #f5f5f5;
            padding: 10px;
            overflow-x: auto;
        }
        button {
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
            margin: 5px;
        }
    </style>
</head>
<body>
    <h1>SRTM2TAK - S3 CORS Validation Test</h1>
    
    <div id="test1" class="test pending">
        <h2>Test 1: Basic S3 Fetch</h2>
        <p>Testing: https://s3.amazonaws.com/elevation-tiles-prod/skadi/N34/N34W081.hgt.gz</p>
        <button onclick="testBasicFetch()">Run Test</button>
        <pre id="test1-result">Click to test...</pre>
    </div>

    <div id="test2" class="test pending">
        <h2>Test 2: CORS Headers Check</h2>
        <p>Verifying Access-Control-Allow-Origin header</p>
        <button onclick="testCorsHeaders()">Run Test</button>
        <pre id="test2-result">Click to test...</pre>
    </div>

    <div id="test3" class="test pending">
        <h2>Test 3: Download Progress</h2>
        <p>Testing partial download with progress tracking</p>
        <button onclick="testDownloadProgress()">Run Test</button>
        <pre id="test3-result">Click to test...</pre>
        <div id="progress-bar" style="display:none;">
            <progress id="progress" max="100" value="0" style="width:100%;"></progress>
            <span id="progress-text">0%</span>
        </div>
    </div>

    <div id="test4" class="test pending">
        <h2>Test 4: Multiple Tiles</h2>
        <p>Testing concurrent downloads of multiple tiles</p>
        <button onclick="testMultipleTiles()">Run Test</button>
        <pre id="test4-result">Click to test...</pre>
    </div>

    <div id="test5" class="test pending">
        <h2>Test 5: Ocean Tile (404)</h2>
        <p>Testing behavior for non-existent tiles (ocean areas)</p>
        <button onclick="testOceanTile()">Run Test</button>
        <pre id="test5-result">Click to test...</pre>
    </div>

    <div id="test6" class="test pending">
        <h2>Test 6: Memory Usage</h2>
        <p>Testing memory consumption during download</p>
        <button onclick="testMemoryUsage()">Run Test</button>
        <pre id="test6-result">Click to test...</pre>
    </div>

    <script>
        function updateTestStatus(testId, status, message) {
            const testDiv = document.getElementById(testId);
            const resultPre = document.getElementById(testId + '-result');
            
            testDiv.className = 'test ' + status;
            resultPre.textContent = message;
        }

        async function testBasicFetch() {
            updateTestStatus('test1', 'pending', 'Testing...');
            
            try {
                const startTime = performance.now();
                const response = await fetch('https://s3.amazonaws.com/elevation-tiles-prod/skadi/N34/N34W081.hgt.gz');
                const endTime = performance.now();
                
                if (response.ok) {
                    const contentLength = response.headers.get('content-length');
                    const contentType = response.headers.get('content-type');
                    
                    const message = `✅ SUCCESS
Status: ${response.status}
Content-Type: ${contentType}
Content-Length: ${contentLength} bytes (${(contentLength / 1024 / 1024).toFixed(2)} MB)
Time: ${(endTime - startTime).toFixed(0)}ms
URL: ${response.url}`;
                    
                    updateTestStatus('test1', 'success', message);
                } else {
                    updateTestStatus('test1', 'error', `❌ Failed: HTTP ${response.status}`);
                }
            } catch (error) {
                updateTestStatus('test1', 'error', `❌ Error: ${error.message}`);
            }
        }

        async function testCorsHeaders() {
            updateTestStatus('test2', 'pending', 'Testing...');
            
            try {
                const response = await fetch('https://s3.amazonaws.com/elevation-tiles-prod/skadi/N34/N34W081.hgt.gz', {
                    method: 'HEAD'
                });
                
                const corsHeader = response.headers.get('access-control-allow-origin');
                const allowMethods = response.headers.get('access-control-allow-methods');
                const maxAge = response.headers.get('access-control-max-age');
                
                const message = `✅ CORS Headers Found
Access-Control-Allow-Origin: ${corsHeader || 'NOT SET'}
Access-Control-Allow-Methods: ${allowMethods || 'NOT SET'}
Access-Control-Max-Age: ${maxAge || 'NOT SET'}

Status: ${corsHeader === '*' ? '✅ CORS enabled for all origins' : '⚠️ CORS may be restricted'}`;
                
                updateTestStatus('test2', corsHeader ? 'success' : 'error', message);
            } catch (error) {
                updateTestStatus('test2', 'error', `❌ Error: ${error.message}`);
            }
        }

        async function testDownloadProgress() {
            updateTestStatus('test3', 'pending', 'Starting download...');
            document.getElementById('progress-bar').style.display = 'block';
            
            try {
                const response = await fetch('https://s3.amazonaws.com/elevation-tiles-prod/skadi/N34/N34W081.hgt.gz');
                const contentLength = +response.headers.get('content-length');
                
                const reader = response.body.getReader();
                let receivedLength = 0;
                const chunks = [];
                
                while(true) {
                    const {done, value} = await reader.read();
                    
                    if (done) break;
                    
                    chunks.push(value);
                    receivedLength += value.length;
                    
                    const percentComplete = (receivedLength / contentLength * 100).toFixed(1);
                    document.getElementById('progress').value = percentComplete;
                    document.getElementById('progress-text').textContent = `${percentComplete}% (${(receivedLength / 1024 / 1024).toFixed(2)} MB / ${(contentLength / 1024 / 1024).toFixed(2)} MB)`;
                }
                
                const message = `✅ Download Complete
Total Size: ${(receivedLength / 1024 / 1024).toFixed(2)} MB
Chunks Received: ${chunks.length}
Average Chunk Size: ${(receivedLength / chunks.length / 1024).toFixed(2)} KB`;
                
                updateTestStatus('test3', 'success', message);
            } catch (error) {
                updateTestStatus('test3', 'error', `❌ Error: ${error.message}`);
            }
        }

        async function testMultipleTiles() {
            updateTestStatus('test4', 'pending', 'Testing concurrent downloads...');
            
            const tiles = [
                'N34/N34W081.hgt.gz',
                'N34/N34W082.hgt.gz',
                'N35/N35W081.hgt.gz'
            ];
            
            try {
                const startTime = performance.now();
                const promises = tiles.map(tile => 
                    fetch(`https://s3.amazonaws.com/elevation-tiles-prod/skadi/${tile}`)
                        .then(r => ({ tile, status: r.status, size: r.headers.get('content-length') }))
                );
                
                const results = await Promise.all(promises);
                const endTime = performance.now();
                
                const message = `✅ Multiple Downloads Tested
Time: ${(endTime - startTime).toFixed(0)}ms

${results.map(r => `${r.tile}: Status ${r.status}, Size: ${r.size ? (r.size / 1024 / 1024).toFixed(2) + ' MB' : 'N/A'}`).join('\n')}

Concurrent downloads: SUPPORTED`;
                
                updateTestStatus('test4', 'success', message);
            } catch (error) {
                updateTestStatus('test4', 'error', `❌ Error: ${error.message}`);
            }
        }

        async function testOceanTile() {
            updateTestStatus('test5', 'pending', 'Testing ocean tile...');
            
            try {
                // Atlantic Ocean coordinates
                const response = await fetch('https://s3.amazonaws.com/elevation-tiles-prod/skadi/N30/N30W040.hgt.gz');
                
                if (response.status === 404) {
                    const message = `✅ Ocean tile correctly returns 404
Status: ${response.status}
This is expected behavior - ocean tiles don't exist
App should handle this gracefully`;
                    
                    updateTestStatus('test5', 'success', message);
                } else {
                    updateTestStatus('test5', 'error', `⚠️ Unexpected status: ${response.status} (expected 404)`);
                }
            } catch (error) {
                updateTestStatus('test5', 'error', `❌ Error: ${error.message}`);
            }
        }

        async function testMemoryUsage() {
            updateTestStatus('test6', 'pending', 'Testing memory usage...');
            
            try {
                const before = performance.memory ? performance.memory.usedJSHeapSize : 0;
                
                // Download and hold in memory
                const response = await fetch('https://s3.amazonaws.com/elevation-tiles-prod/skadi/N34/N34W081.hgt.gz');
                const arrayBuffer = await response.arrayBuffer();
                
                const after = performance.memory ? performance.memory.usedJSHeapSize : 0;
                
                if (performance.memory) {
                    const message = `✅ Memory Usage Tracked
Before Download: ${(before / 1024 / 1024).toFixed(2)} MB
After Download: ${(after / 1024 / 1024).toFixed(2)} MB
Increase: ${((after - before) / 1024 / 1024).toFixed(2)} MB
ArrayBuffer Size: ${(arrayBuffer.byteLength / 1024 / 1024).toFixed(2)} MB

Heap Limit: ${(performance.memory.jsHeapSizeLimit / 1024 / 1024).toFixed(0)} MB
Current Usage: ${(performance.memory.usedJSHeapSize / performance.memory.jsHeapSizeLimit * 100).toFixed(1)}%`;
                    
                    updateTestStatus('test6', 'success', message);
                } else {
                    updateTestStatus('test6', 'error', '⚠️ performance.memory not available (try Chrome with --enable-precise-memory-info flag)');
                }
            } catch (error) {
                updateTestStatus('test6', 'error', `❌ Error: ${error.message}`);
            }
        }

        // Run basic test automatically on load
        window.addEventListener('load', () => {
            console.log('SRTM2TAK S3 Validation Test Suite Loaded');
            console.log('Click each test button to validate S3 access');
        });
    </script>
</body>
</html>